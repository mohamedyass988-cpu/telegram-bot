import telebot
from telebot import types
import sqlite3

# ========= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =========
TOKEN = "8526935801:AAGqEAor9n91knVeDoTXF5mQdgqS_udPEY8"
ADMIN_ID = 8590809949
CHANNEL_USERNAME = "@velkor_crash"

bot = telebot.TeleBot(TOKEN)

# ========= Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =========
conn = sqlite3.connect("database.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    points INTEGER DEFAULT 3,
    invited_by INTEGER
)
""")
conn.commit()

# ========= Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ =========
def check_subscription(user_id):
    try:
        member = bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status in ["member", "administrator", "creator"]
    except:
        return False

# ========= Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =========
def send_main_menu(chat_id, user_id):
    cursor.execute("SELECT points FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    points = result[0] if result else 0

    markup = types.InlineKeyboardMarkup()
    markup.row(types.InlineKeyboardButton("ğŸ“ ÙØ­Øµ Ø±Ù‚Ù…", callback_data="check_number"))
    markup.row(
        types.InlineKeyboardButton("ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ", callback_data="my_account"),
        types.InlineKeyboardButton("ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©", callback_data="invite_link")
    )

    if user_id == ADMIN_ID:
        markup.row(types.InlineKeyboardButton("âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†", callback_data="admin_panel"))

    bot.send_message(chat_id,
                     f"ğŸ”¥ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨ÙˆØª\n\nğŸ’ Ù†Ù‚Ø§Ø·Ùƒ: {points}",
                     reply_markup=markup)

# ========= /start =========
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    username = message.from_user.first_name

    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()

    if not user:
        invited_by = None
        if len(message.text.split()) > 1:
            invited_by = int(message.text.split()[1])
            if invited_by != user_id:
                cursor.execute("UPDATE users SET points = points + 5 WHERE user_id = ?", (invited_by,))
        cursor.execute("INSERT INTO users (user_id, invited_by) VALUES (?, ?)", (user_id, invited_by))
        conn.commit()

    if not check_subscription(user_id):
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ğŸ“¢ Ø§Ø´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø©", url="https://t.me/velkor_crash"))
        markup.add(types.InlineKeyboardButton("âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_sub"))

        bot.send_message(message.chat.id,
                         f"ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§ ÙŠØ§ {username}\n\n"
                         "Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© Ù„ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙˆØª ğŸ‘‡",
                         reply_markup=markup)
        return

    send_main_menu(message.chat.id, user_id)

# ========= Ø§Ù„Ø£Ø²Ø±Ø§Ø± =========
@bot.callback_query_handler(func=lambda call: True)
def callbacks(call):
    user_id = call.from_user.id

    if call.data == "check_sub":
        if check_subscription(user_id):
            bot.answer_callback_query(call.id, "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚")
            send_main_menu(call.message.chat.id, user_id)
        else:
            bot.answer_callback_query(call.id, "âŒ Ù„Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø¹Ø¯")

    elif call.data == "my_account":
        cursor.execute("SELECT points FROM users WHERE user_id = ?", (user_id,))
        points = cursor.fetchone()[0]
        bot.send_message(call.message.chat.id,
                         f"ğŸ‘¤ Ø­Ø³Ø§Ø¨Ùƒ\n\nğŸ’ Ù†Ù‚Ø§Ø·Ùƒ: {points}")

    elif call.data == "invite_link":
        link = f"https://t.me/{bot.get_me().username}?start={user_id}"
        bot.send_message(call.message.chat.id,
                         f"ğŸ”— Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ:\n{link}\n\n"
                         "ğŸ ÙƒÙ„ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„ Ù…Ù† Ø±Ø§Ø¨Ø·Ùƒ ÙŠØ¹Ø·ÙŠÙƒ 5 Ù†Ù‚Ø§Ø·")

    elif call.data == "check_number":
        bot.send_message(call.message.chat.id,
                         "ğŸ“ Ø§Ø±Ø³Ù„ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ù…Ø«Ø§Ù„:\n+201234567890")

    elif call.data == "admin_panel" and user_id == ADMIN_ID:
        cursor.execute("SELECT COUNT(*) FROM users")
        total_users = cursor.fetchone()[0]

        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø©", callback_data="broadcast"))

        bot.send_message(call.message.chat.id,
                         f"âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†\n\nğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}",
                         reply_markup=markup)

    elif call.data == "broadcast" and user_id == ADMIN_ID:
        msg = bot.send_message(call.message.chat.id, "âœ‰ï¸ Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†:")
        bot.register_next_step_handler(msg, send_broadcast)

# ========= Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© =========
def send_broadcast(message):
    if message.from_user.id != ADMIN_ID:
        return

    cursor.execute("SELECT user_id FROM users")
    users = cursor.fetchall()

    for user in users:
        try:
            bot.send_message(user[0], message.text)
        except:
            pass

    bot.send_message(message.chat.id, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©")

# ========= Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… =========
@bot.message_handler(func=lambda m: m.text and m.text.startswith("+"))
def handle_number(message):
    user_id = message.from_user.id

    if not check_subscription(user_id):
        bot.send_message(message.chat.id, "âŒ Ø§Ø´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¶ØºØ· /start")
        return

    cursor.execute("SELECT points FROM users WHERE user_id = ?", (user_id,))
    points = cursor.fetchone()[0]

    if points <= 0:
        bot.send_message(message.chat.id,
                         "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ©.\n"
                         "Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·.")
        return

    cursor.execute("UPDATE users SET points = points - 1 WHERE user_id = ?", (user_id,))
    conn.commit()

    number = message.text

    # Ø¶Ø¹ Ù‡Ù†Ø§ Ø£ÙŠ ÙØ­Øµ Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙÙ‚Ø·
    bot.send_message(message.chat.id,
                     f"ğŸ“ Ø§Ù„Ø±Ù‚Ù…: {number}\n\n"
                     "(Ù‡Ù†Ø§ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ)\n\n"
                     "ØªÙ… Ø®ØµÙ… 1 Ù†Ù‚Ø·Ø© âœ…")

print("ğŸš€ Bot is running...")
bot.infinity_polling()
